@page "/add-user"
@inject NavigationManager Nav
@inject HttpClient Http

@inject UserSession Session

<link href="css/add-user.css" rel="stylesheet" />

<div class="adduser-bg">

    <!-- HEADER -->
    <div class="adduser-header">
        <span class="back" @onclick='() => Nav.NavigateTo("/dashboard")'>&larr;</span>
        <h3>Add User</h3>
    </div>

    <!-- PROFILE IMAGE -->
    <div class="profile-section">
        <img src="images/NewUser.png" class="profile-img" />
        <div class="camera-icon">
            <img src="images/camera_icon.svg" />
        </div>
    </div>

    <!-- FORM -->
    <div class="form">

        <label>Registration Number</label>
        <div class="input-box @(string.IsNullOrEmpty(regError) ? "" : "error")">
            <img src="images/icon-mobile.svg" />
            <input placeholder="Enter Registration Number" @bind="RegNo" />
            @if (!string.IsNullOrEmpty(regError))
            {
                <span class="error-icon">i</span>
            }
        </div>

        <label>User Name</label>
        <div class="input-box @(string.IsNullOrEmpty(nameError) ? "" : "error")">
            <img src="images/icon-user.svg" />
            <input placeholder="Enter User Name" @bind="UserName" />
            @if (!string.IsNullOrEmpty(nameError))
            {
                <span class="error-icon">i</span>
            }
        </div>

        <label>Enter Mobile Number</label>
        <div class="input-box @(string.IsNullOrEmpty(mobileError) ? "" : "error")">
            <img src="images/icon-mobile.svg" />
            <input placeholder="Enter Mobile Number" @bind="Mobile" />
            @if (!string.IsNullOrEmpty(mobileError))
            {
                <span class="error-icon">i</span>
            }
        </div>
        <label>Alternate Mobile Number</label>
        <div class="input-box @(string.IsNullOrEmpty(alternateError) ? "" : "error")">
            <img src="images/icon-mobile.svg" />
            <input placeholder="Enter Alternate Mobile Number" @bind="AlternateMobile" />
            @if (!string.IsNullOrEmpty(alternateError))
            {
                <span class="error-icon">i</span>
            }
        </div>

        <label>User Email Address</label>
        <div class="input-box @(string.IsNullOrEmpty(emailError) ? "" : "error")">
            <img src="images/icon-email.svg" />
            <input placeholder="Enter Email" @bind="Email" />
            @if (!string.IsNullOrEmpty(emailError))
            {
                <span class="error-icon">i</span>
            }
        </div>

        <!-- DEVICE IDENTIFIER -->
        <label>
            @(isIphone ? "Device Serial Number" : "First Device IMEI Number")
        </label>
        <div class="imei-box @(string.IsNullOrEmpty(imei1Error) ? "" : "error")">
            <img src="images/icon-qr.svg" class="imei-icon" />
            <img src="images/icon-registration.svg" class="imei-icon" />
            <input placeholder="Enter @(isIphone ? "serial number" : "first IMEI number")"
                   @bind="Imei1" />
            @if (!string.IsNullOrEmpty(imei1Error))
            {
                <span class="error-icon">i</span>
            }
        </div>

        @if (!isIphone)
        {
            <label>Second Device IMEI Number</label>
            <div class="imei-box @(string.IsNullOrEmpty(imei2Error) ? "" : "error")">
                <img src="images/icon-qr.svg" class="imei-icon" />
                <img src="images/icon-registration.svg" class="imei-icon" />
                <input placeholder="Enter second IMEI number" @bind="Imei2" />
                @if (!string.IsNullOrEmpty(imei2Error))
                {
                    <span class="error-icon">i</span>
                }
            </div>
        }

        <button class="submit-btn" @onclick="Submit">Submit</button>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? device { get; set; }

    bool isIphone => device == "iphone";

    string RegNo = "";
    string UserName = "";
    string Mobile = "";
    string Email = "";
    string Imei1 = "";
    string AlternateMobile = "";
    string alternateError = "";
    string Imei2 = "";

    string regError = "";
    string nameError = "";
    string mobileError = "";
    string emailError = "";
    string imei1Error = "";
    string imei2Error = "";

    async Task Submit()
{
    regError = nameError = mobileError = emailError = imei1Error = imei2Error = "";
    bool hasError = false;

    if (string.IsNullOrWhiteSpace(RegNo)) { regError = "error"; hasError = true; }
    if (string.IsNullOrWhiteSpace(UserName)) { nameError = "error"; hasError = true; }
    if (string.IsNullOrWhiteSpace(Email)) { emailError = "error"; hasError = true; }
    if (string.IsNullOrWhiteSpace(Imei1)) { imei1Error = "error"; hasError = true; }
    if (!isIphone && string.IsNullOrWhiteSpace(Imei2)) { imei2Error = "error"; hasError = true; }

    if (!isIphone && string.IsNullOrWhiteSpace(AlternateMobile))
    {
        alternateError = "error";
        hasError = true;
    }

    if (hasError) return;

    try
    {
        var content = new MultipartFormDataContent();
        string apiUrl;

        Http.DefaultRequestHeaders.Authorization =
            new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Session.Token);

        if (isIphone)
        {
            // IOS API
            apiUrl = "api/IOSCustomer/AddIOSCustomer";

            content.Add(new StringContent(UserName), "Name");
            content.Add(new StringContent(Mobile), "Mobile");
            content.Add(new StringContent(Email), "Email");

            content.Add(new StringContent(
                string.IsNullOrWhiteSpace(AlternateMobile) ? "" : AlternateMobile
            ), "AlternateMobile");

            // IOS expects SerialNumber
            content.Add(new StringContent(Imei1), "SerialNumber");

            content.Add(new StringContent(Session.DealerProfileId), "DealerId");
        }
        else
        {
            // ðŸ¤– Android API
            apiUrl = "api/Customer/AddCustomer";

            content.Add(new StringContent(UserName), "Name");
            content.Add(new StringContent(Mobile), "Mobile");
            content.Add(new StringContent(Mobile), "AlternateMobile");
            content.Add(new StringContent(Email), "Email");

            // Android expects IMEI numbers
            content.Add(new StringContent(Imei1), "FirstIMEINumber");
            content.Add(new StringContent(Imei2), "SecondIMEINumber");

            content.Add(new StringContent(Session.DealerProfileId), "Dealerid");
        }

        Console.WriteLine("Calling API: " + apiUrl);

        var response = await Http.PostAsync(apiUrl, content);

        var responseText = await response.Content.ReadAsStringAsync();
        Console.WriteLine("STATUS: " + response.StatusCode);
        Console.WriteLine("RESPONSE: " + responseText);

        if (response.IsSuccessStatusCode)
        {
            // Go back to dashboard and reload everything
            Nav.NavigateTo("/dashboard", true);
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine("ERROR: " + ex.Message);
    }
}
}