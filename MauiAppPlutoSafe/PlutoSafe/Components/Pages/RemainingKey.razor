@page "/remaining-key"
@inject UserSession Session
@inject HttpClient Http
@inject NavigationManager Nav


<div class="rk-bg">

    <!-- HEADER -->
    <div class="rk-header">
        <span class="back" @onclick='() => Nav.NavigateTo("/dashboard")'>&larr;</span>
        <h3>Remaining Key</h3>
    </div>

    <!-- COLOURED KEY BAR -->
    <div class="rk-status">
        <span>Remaining Key</span>
        <b>@remainingKeyCount</b>
    </div>
</div>
@code {

    int? remainingKeyCount = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadRemainingKeyCount();
    }

    async Task LoadRemainingKeyCount()
    {
        try
        {
            var dealerId = Session.DealerProfileId;

            if (string.IsNullOrEmpty(dealerId))
            {
                remainingKeyCount = 0;
                return;
            }

            // Attach token if required
            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Session.Token);

            var response = await Http.GetFromJsonAsync<RemainingKeyResponse>(
                $"api/IOSDashboardDevicesList/GetRemainingIOSKeys/{dealerId}");

            if (response != null && response.isSuccess)
            {
                remainingKeyCount = response.data;

                // Store for dashboard
                Session.RemainingKeyCount = response.data;
            }
            else
            {
                remainingKeyCount = 0;
                Session.RemainingKeyCount = 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("ERROR: " + ex.ToString());
            remainingKeyCount = 0;
            Session.RemainingKeyCount = 0;
        }
    }

    public class RemainingKeyResponse
    {
        public bool isSuccess { get; set; }
        public int data { get; set; }
        public string message { get; set; }
    }
}