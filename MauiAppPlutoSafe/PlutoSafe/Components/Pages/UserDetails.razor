
@* @page "/" *@
@page "/user-details/{SerialNumber}"
@using PlutoSafe.Components.Shared
@using Microsoft.Maui.ApplicationModel;
@using Microsoft.Maui.Media
@using System.Net.Http.Headers;
@using System.Text.Json

@inject NavigationManager Nav
@* @inject JSRuntime JS *@
@inject IJSRuntime JS

<link href="user-details.css" rel="stylesheet" />

<!-- ================= PAGE CONTENT (BLURRED) ================= -->
<div class="ud-bg @(showAgreement ? "blur-bg" : "")">

    <!-- HEADER -->
    <div class="ud-header">
        <span class="back" @onclick='() => Nav.NavigateTo("/dashboard")'>&larr;</span>
        <h3>User Details</h3>
    </div>

    <!-- USER CARD -->
    <div class="ud-card">

        <!-- TABS -->
        <div class="ud-tabs">
            <span class="@(activeTab == "details" ? "active" : "")"
                  @onclick='() => activeTab = "details"'>
                USER DETAILS
            </span>

            <span class="@(activeTab == "loan" ? "active" : "")"
                  @onclick='() => activeTab = "loan"'>
                CREATE LOAN
            </span>

            <span class="@(activeTab == "show" ? "active" : "")"
                  @onclick='async() => { activeTab = "show"; await LoadShowLoan();}'>
                SHOW LOAN
            </span>

            <span class="@(activeTab == "emi" ? "active" : "")"
                  @onclick='() => activeTab = "emi"'>
                EMI REMINDER
            </span>
        </div>

    @if (activeTab == "show")
    {
        <div class="show-loan">

            <!-- PROFILE -->
            <div class="show-profile">
                <img src="images/avatar-girl.svg" class="show-avatar" />
                <h4>@userDetail?.name</h4>
            </div>

            <!-- LOAN + STATUS CARD -->
            <div class="show-card">
                <div class="show-item">
                    <img src="images/down.svg" />
                    <div>
                        <span>Loan ID</span>
                        <strong>@showLoanData?.id</strong>
                    </div>
                </div>

                <div class="show-item">
                    <img src="images/lockstatus.svg" />
                    <div>
                        <span>Phone Lock Status</span>
                        <strong class="unlock">
                            @(showLoanData?.isActive == true ? "Active" : "Inactive")
                        </strong>
                    </div>
                </div>
            </div>

            <!-- DEVICE DETAILS -->
            <div class="show-section">
                <h5>Device Details</h5>

                <div class="show-row">
                    <img src="images/devicedetail.svg" />
                    <div>
                        <p>Sereal No</p>
                        <strong>@SerialNumber</strong>
                    </div>
                </div>

                <div class="show-row">
                    <img src="images/devicedetail.svg" />
                    <div>
                        <p>Product Name</p>
                        <strong>
                            @(showLoanData!=null ? showLoanData.productName : "_")
                        </strong>
                    </div>
                </div>
            </div>

            <!-- LOAN DETAILS GRID -->
            <div class="show-section">
                <h5>Device Details</h5>

                <div class="loan-grid">
                    <div>Product Price <strong>@showLoanData?.productPrice</strong></div>
                    <div>Down Payment <strong>@showLoanData?.downPayment</strong></div>

                    <div>EMI Amount <strong>@showLoanData?.actualEmi</strong></div>
                    <div>Number Of EMI <strong>@showLoanData?.numberOfEmi</strong></div>

                    <div>Processing Fees <strong>@showLoanData?.processingFee</strong></div>
                    <div>Loan Amount <strong>@showLoanData?.loanAmount</strong></div>

                    <div>Total Paid Amount <strong>@TotalPaidAmount</strong></div>
                    <div>Balance Amount <strong>@BalanceAmount</strong></div>

                    <div>EMI Due Amount <strong>@EmiDueAmount</strong></div>
                    <div>Penalty Amount <strong>@PenaltyAmount</strong></div>
                </div>
            </div>

            <!-- DOWNLOAD -->
            <button class="download-btn" @onclick="OpenPdf">
                Download PDF
            </button>

            <!-- DOCUMENT -->
           <h5 class="doc-title">View Document's</h5>

            <div class="doc-grid">
                <div class="doc-item">
                    <img src="images/eye.png" />
                    <p>Aadhar front</p>
                </div>

                <div class="doc-item">
                    <img src="images/eye.png" />
                    <p>Aadhar back</p>
                </div>

                <div class="doc-item">
                    <img src="images/eye.png" />
                    <p>Photo</p>
                </div>

                <div class="doc-item">
                    <img src="images/eye.png" />
                    <p>PAN</p>
                </div>
                </div>
            </div>
    }

    @if (activeTab == "emi")
    {
        <div class="emi-list">

            @foreach (var emi in EmiList)
            {
                <div class="emi-card @(emi.IsPaid ? "paid" : "unpaid highlight")">
                    <span class="emi-index">@emi.Index</span>

                    <div class="emi-left">
                        <img src="@(emi.IsPaid ? "images/paid.svg" : "images/unpaid.svg")"
                            class="emi-stamp" />

                        <div class="emi-info">
                            <p>Date</p>
                            <p>Mode</p>
                            <p>Amount</p>
                        </div>
                    </div>

                    <div class="emi-right">
                        <p>@emi.Date.ToString("dd/MM/yyyy")</p>
                        <p>@(emi.Mode ?? "—")</p>
                        <p>@emi.Amount</p>

                        @if (!emi.IsPaid)
                        {
                            <button class="update-btn"
                                    @onclick="() => OpenEmiModal(emi)">
                                Update
                            </button>
                        }
                    </div>
                </div>
            }

        </div>
    }
        <!-- USER DETAILS -->
        @if (activeTab == "details")
        {

        <div class="ud-profile-card">

            <div class="ud-top">
                <img src="images/avatar-girl.svg" class="avatar" />
                <div class="name-box">
                    <h4>@userDetail?.name</h4>
                </div>
                
                <button class="unlock-btn">
                    <span class="unlock-circle">
                        <img src="images/unlock.svg" />
                    </span>
                    Unlock
                </button>
            </div>
            
               <div class="ud-meta">

            <div class="meta-card meta-date">
                <div class="meta-top">
                    <img src="images/icon-calendar.svg" />
                    <span>Date</span>
                </div>
                <div class="meta-value">
                    @DateTime.Now.ToString("dd/MM/yyyy")
                </div>
            </div>

            <div class="meta-card meta-time">
                <div class="meta-top">
                    <img src="images/icon-clock.svg" />
                    <span>Time</span>
                </div>
                <div class="meta-value">
                    @DateTime.Now.ToString("HH:mm tt")
                </div>
            </div>

            <div class="meta-card meta-code">
                <div class="meta-top">
                    <img src="images/secure-code.svg" />
                    <span>Secure code</span>
                </div>
                <div class="meta-value">
                    @RegNo
                </div>
            </div>

        </div>

            <div class="info">
                <p><img src="images/register.svg" /> Registration Number : @userDetail?.loanAccountNumber</p>
                <p><img src="images/icon-registration.svg" /> Serial No : @userDetail?.serialNumber</p>
                <p><img src="images/call.svg" /> Alternate Mobile Number : @userDetail?.alternateMobile</p>
            </div>

        </div>

        <div class="quick-actions">
            <div><img src="images/icon-contact.svg" /></div>
            <div><img src="images/icon-location.svg" /></div>
        </div>

        <h4 class="section">Features</h4>

        <div class="feature-list">

            <!-- Set Wallpaper -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/set-wallpaper.png" />
                    <span>Set Wallpaper</span>
                </div>
                @* <CommandToggle/> *@
       <div class="toggle-wrapper">
            <label class="switch">
                <input type="checkbox"
                       checked="@wallpaperToggle"
                       @onclick="() => HandleClick(nameof(wallpaperToggle))"
                       @onclick:preventDefault="true" />
                <span class="slider"></span>
            </label>
        </div>
            </div>


            <!-- Lock Social Media -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/lock-social-media.png" />
                    <span>Lock Social Media</span>
                </div>
                        <div class="toggle-wrapper">
            <label class="switch">
                <input type="checkbox"
                       checked="@socialToggle"
                       @onclick="() => HandleClick(nameof(socialToggle))"
                       @onclick:preventDefault="true" />
                <span class="slider"></span>
            </label>
        </div>
            </div>
            <!-- Track Location -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/icon-mic.svg" />
                    <span>Track Location</span>
                </div>
                <div class="toggle-wrapper">
            <label class="switch">
                <input type="checkbox"
                       checked="@locationToggle"
                       @onclick="() => HandleClick(nameof(locationToggle))"
                       @onclick:preventDefault="true" />
                <span class="slider"></span>
            </label>
        </div>
            </div>
            <!-- Audio Reminder -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/icon-mic.svg" />
                    <span>Audio Reminder</span>
                </div>
            </div>

            <!-- Screen Reminder -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/lock-social-media.png" />
                    <span>Screen Reminder</span>
                </div>
            </div>

                        <!-- Offline App Lock -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/offline-app-lock.png" />
                    <span>Offline App Lock</span>
                </div>
            </div>

            <!-- Offline App Lock -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/applock.png" />
                    <span>Offline App UnLock</span>
                </div>
            </div>

            <!-- Remove -->
            <div class="feature">
                <div class="feature-left">
                    <img src="images/icon-mic.svg" />
                    <span>Remove</span>
                </div>
                        <div class="toggle-wrapper">
            <label class="switch">
                <input type="checkbox"
                       checked="@removeToggle"
                       @onclick="() => HandleClick(nameof(removeToggle))"
                       @onclick:preventDefault="true" />
                <span class="slider"></span>
            </label>
        </div>
            </div>

        </div>          
    }

    <!-- CREATE LOAN -->
    @if (activeTab == "loan")
    {
        <div class="cl-bg">
            <div class="cl-form">

                <label>Product Name</label>
        <div class="input-box">
            <img src="images/icon-box.svg" />
            <input @bind="productName" placeholder="Enter Product Name" />
        </div>

        <label>Product Price</label>
        <div class="input-box">
            <img src="images/icon-rupee.svg" />
            <input type="number" @bind="productPrice" />
        </div>

        <label>Processing Fees</label>
        <div class="input-box">
            <img src="images/icon-rupee.svg" />
            <input type="number" @bind="processingFee" />
        </div>

        <label>Down Payment</label>
        <div class="input-box">
            <img src="images/icon-wallet.svg" />
            <input type="number" @bind="downPayment" />
        </div>

        <label>Loan Amount</label>
        <div class="input-box">
            <img src="images/icon-rupee.svg" />
            <input type="number" @bind="loanAmount" />
        </div>

        <label>Number Of EMI</label>
        <div class="input-box">
            <img src="images/icon-emi.svg" />
            <input type="number" @bind="numberOfEmi" />
        </div>

        <label>Actual EMI</label>
        <div class="input-box">
            <img src="images/emi-no.svg" />
            <input type="number" @bind="actualEmi" />
        </div>

        <label>First EMI Date</label>
        <div class="input-box">
            <img src="images/icon-calendar.svg" />
            <input type="date" @bind="firstEmiDate" />
        </div>      

        <label>Upload Document’s</label>
        <div class="upload-grid">

            <button type="button" class="upload-item"
                    @onclick='() => PickImage("Aadhaar Front")'>
                <img src="images/plus.svg" />
                <span>Aadhaar Front</span>
            </button>

            <button type="button" class="upload-item"
                    @onclick='() => PickImage("Aadhaar Back")'>
                <img src="images/plus.svg" />
                <span>Aadhaar Back</span>
            </button>

            <button type="button" class="upload-item"
                    @onclick='() => PickImage("Pan Card")'>
                <img src="images/plus.svg" />
                <span>Pan Card</span>
            </button>

            <button type="button" class="upload-item"
                    @onclick='() => PickImage("Photo")'>
                <img src="images/plus.svg" />
                <span>Photo</span>
            </button>

        </div>
                <div class="guarantor-row">
                    <span class="guarantor-text">Do You Want To Add A Guarantor?</span>
                    @if(guarantors.Count <2){
                        <button class="add-btn" @onclick="AddGuarantor"><span>+ADD</span></button>
                    }
                </div>
                @foreach (var g in guarantors)
                {
                    <div class="guarantor-section">

                        <label>Guarantor Name</label>
                        <div class="input-box">
                            <input class="g-input" placeholder="Name" />
                        </div>

                        <label>Guarantor Mobile Number</label>
                        <div class="input-box">
                            <input class="g-input" placeholder="Enter Mobile Number" />
                        </div>

                        <label>Address</label>
                        <div class="input-box">
                            <input class="g-input" placeholder="Enter Address" />
                        </div>

                        <label>Guarantor Upload Aadhar</label>
                        <div class="upload-grid">
                            <button class="upload-item">
                                <img src="images/plus.svg" />
                                <span>Aadhaar Front</span>
                            </button>

                            <button class="upload-item">
                                <img src="images/plus.svg" />
                                <span>Aadhaar Back</span>
                            </button>
                        </div>
                        <button class=" add-btn add-icon-only" @onclick="AddGuarantor">
                            <span>+Add</span>
                        </button>
                    </div>
                }
                    <div class="agreement-box">
                        <p class="agreement-title">Agreement</p>
           
                     <p class="agreement-text">
                            This Loan Agreement is made and entered into by and between the Lender
                            and the Borrower for the purpose of providing a personal or business loan.
                            The Borrower hereby acknowledges the receipt of the loan amount and agrees
                            to repay the same, along with the applicable interest rate
                        </p>

                        <span class="see-more" @onclick="OpenAgreement">See More</span>

                        <div class="agreement">
                            <input type="checkbox" />
                            <p>I have read and understood the above loan agreement.</p>
                        </div>
                    </div>

                <label class="signature-title">Signature</label>
                <div class="signature-container" style="width:100%; height:100%;">
                    <canvas id="loanSignatureCanvas"
                        style="width:100%; height:100%; background:#F0F0F3; border:1px solid #f1eaea; border-radius:8px;">
                        </canvas>
                    <img src="images/icon-edit.svg"
                        class="edit-icon"
                        @onclick="Clear" />
                </div>
               </div>
            </div>
        }
            <button class="submit-btn"
                @onclick="CreateLoan" 
                >
                Submit
            </button>

    </div>   <!-- closes ud-card -->

    @if (showEmiModal && SelectedEmi != null)
    {
        <div class="emi-overlay">
            <div class="emi-modal">

                <div class="emi-header">
                    <span>EMI Details</span>
                    <span class="emi-close" @onclick="CloseEmiModal">✕</span>
                </div>

                <div class="emi-body">

                    <div class="emi-row">
                        <label>Amount</label>
                        <span>: @SelectedEmi.Amount</span>
                    </div>

                    <div class="emi-row">
                        <label>EMI Date</label>
                        <span>: @SelectedEmi.Date.ToString("yyyy-MM-dd")</span>
                    </div>

                    <div class="emi-row">
                        <label>Payment Mode</label>
                        <select @bind="SelectedPaymentMode">
                            <option value="">Select</option>
                            <option>Online</option>
                            <option>UPI</option>
                            <option>Cash</option>
                            <option>Bank Transfer</option>
                        </select>
                    </div>

                    <div class="emi-actions">
                        <button class="emi-cancel" @onclick="CloseEmiModal">Cancel</button>
                        <button class="emi-ok" @onclick="SubmitEmi">OK</button>
                    </div>

                </div>
            </div>
        </div>
    }

    <!-- ================= AGREEMENT MODAL (NOT BLURRED) ================= -->
    @if (showAgreement)
    {
        <div class="agreement-overlay">
            <div class="agreement-modal">
                <div class="agreement-header">
                    <span>Agreement</span>
                    <span class="close" @onclick="CloseAgreement">×</span>
                </div>

                <div class="agreement-body">
                    <p>
                        this loan agreement is made and entered into by and between the lender
                        and the borrower for the purpose of providing a personal or business loan.
                        the borrower hereby acknowledges the receipt of the loan amount and agrees
                        to repay the same, along with the applicable interest rate, within the
                        period mutually agreed upon by both parties.
                    </p>

                    <p>
                        in the event of any delay or failure to make timely payments, the borrower
                        shall be liable to pay late fees or additional charges in accordance with
                        the lender’s policy.
                    </p>

                    <p>
                        both parties confirm that the details and information shared during this
                        agreement are accurate and truthful to the best of their knowledge.
                    </p>
                </div>
            </div>
        </div>
    }
</div>

@if (showPopup)
{
    <div class="command-overlay">
        <div class="command-modal">

            <div class="command-header">
                <span>Warning</span>
                <span class="close" @onclick="ClosePopup">✕</span>
            </div>

            <div class="command-body">
                <p>Are you sure you want to proceed?</p>

                <div class="command-actions">
                    <button class="yes-btn" @onclick="ConfirmAction">Yes</button>
                    <button class="no-btn" @onclick="ClosePopup">No</button>
                </div>
            </div>

        </div>
    </div>
}

@code {
    private bool isChecked;
    private bool showPopup;
    private bool pendingValue;

    [Inject] HttpClient Http { get; set; }
    [Inject] UserSession Session { get; set; }

    IosUserDetail? userDetail;

    [Parameter] 
    public string SerialNumber { get; set; }  // pass this from previous page
    string activeTab = "details";
    bool showAgreement = false;
    void OpenAgreement() => showAgreement = true;
    void CloseAgreement() => showAgreement = false;
    [Parameter] public string RegNo { get; set; } = "124545445";
    private bool wallpaperToggle;
    private bool socialToggle;
    private bool locationToggle;
    private bool removeToggle;
    ShowLoanData? showLoanData;

    private string productName;
    private decimal productPrice;
    private decimal processingFee;
    private decimal downPayment;
    private decimal loanAmount;
    private int numberOfEmi;
    private decimal actualEmi;
    private DateTime firstEmiDate;
    public string customerId { get; set; }

    private string currentToggle;

   protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadUserDetail();
            StateHasChanged();
        }

        if (activeTab == "loan")
        {
            await Task.Delay(100);
            await JS.InvokeVoidAsync("initSignature", "loanSignatureCanvas");
        }
    }

    async Task LoadShowLoan()
    {
        try
        {
            if (string.IsNullOrEmpty(userDetail?.customerId))
                return;

            Http.DefaultRequestHeaders.Authorization =
                new AuthenticationHeaderValue("Bearer", Session.Token);

            var response = await Http.GetFromJsonAsync<ShowLoanResponse>(
                $"https://devmobileapi.plutosafe.in/api/IOSCustomerLoan/GetIOSCustomerLoan/{userDetail.customerId}");

            if (response != null && response.isSuccess && response.data?.Any() == true)
            {
                showLoanData = response.data.FirstOrDefault();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task Clear()
    {
        await JS.InvokeVoidAsync("clearSignature");
    }

    async Task LoadUserDetail()
    {
        try
        {
            if (string.IsNullOrEmpty(SerialNumber))
                return;

            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Session.Token);

            var response = await Http.GetFromJsonAsync<UserDetailResponse>(
                $"https://devmobileapi.plutosafe.in/api/IOSCustomer/GetiOSUserDetail?serialNumber={SerialNumber}");

            if (response != null && response.isSuccess)
            {
                userDetail = response.data;
                socialToggle = userDetail.isSocialMediaLock;
                removeToggle = userDetail.isRemoveApp;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task Save()
    {
        var base64 = await JS.InvokeAsync<string>("getSignature");

        if (!string.IsNullOrEmpty(base64))
        {
            Console.WriteLine(base64);
        }
    }
    private List<int> guarantors = new List<int>();

    private void AddGuarantor()
    {
        if (guarantors.Count < 2)
            guarantors.Add(guarantors.Count + 1);
    }

    private void RemoveGuarantor(int id)
    {
        guarantors.Remove(id);
    }
    private async Task OpenPdf()
    {
        using var stream = await FileSystem.OpenAppPackageFileAsync("UserLoanAgreementForm.pdf");

        var filePath = Path.Combine(FileSystem.CacheDirectory, "UserLoanAgreementForm.pdf");

        using var fileStream = File.Create(filePath);
        await stream.CopyToAsync(fileStream);

        await Launcher.Default.OpenAsync(new OpenFileRequest
        {
            File = new ReadOnlyFile(filePath)
        });
    }
    private async Task PickImage(string type)
    {
        try
        {
            var action = await Application.Current.MainPage.DisplayActionSheet(
                "Select Option",
                "Cancel",
                null,
                "Camera",
                "Gallery");

            FileResult photo = null;

            if (action == "Camera")
            {
                if (MediaPicker.Default.IsCaptureSupported)
                    photo = await MediaPicker.Default.CapturePhotoAsync();
            }
            else if (action == "Gallery")
            {
                photo = await MediaPicker.Default.PickPhotoAsync();
            }

            if (photo != null)
            {
                var stream = await photo.OpenReadAsync();
                Console.WriteLine($"Selected file: {photo.FileName}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }


    private void ClosePopup()
    {
        showPopup = false;
    }
    private void HandleClick(string toggleName)
    {
        currentToggle = toggleName;

        pendingValue = toggleName switch
        {
            nameof(wallpaperToggle) => !wallpaperToggle,
            nameof(socialToggle) => !socialToggle,
            nameof(locationToggle) => !locationToggle,
            nameof(removeToggle) => !removeToggle,
            _ => false
        };

        showPopup = true;
    }

    private void ConfirmAction()
    {
        switch (currentToggle)
        {
            case nameof(wallpaperToggle):
                wallpaperToggle = pendingValue;
                break;

            case nameof(socialToggle):
                socialToggle = pendingValue;
                break;

            case nameof(locationToggle):
                locationToggle = pendingValue;
                break;

            case nameof(removeToggle):
                removeToggle = pendingValue;
                break;
        }

        showPopup = false;
    }
    private List<EmiModel> EmiList = new()
    {
        new EmiModel { Index = 1, Date = DateTime.Parse("2025-08-20"), Mode = "Online", Amount = 3254, IsPaid = true },
        new EmiModel { Index = 2, Date = DateTime.Parse("2025-09-20"), Mode = null, Amount = 3254, IsPaid = false },
        new EmiModel { Index = 3, Date = DateTime.Parse("2025-10-20"), Mode = null, Amount = 3254, IsPaid = false }
    };

    private EmiModel? SelectedEmi;
    private bool showEmiModal = false;

    private void OpenEmiModal(EmiModel emi)
    {
        SelectedEmi = emi;
        showEmiModal = true;
    }

    private void CloseEmiModal()
    {
        showEmiModal = false;
    }

    private void SubmitEmi()
    {
        if (SelectedEmi != null)
        {
            SelectedEmi.Mode = SelectedPaymentMode;
            SelectedEmi.IsPaid = true;
        }

        showEmiModal = false;
    }

    private string SelectedPaymentMode = "";

    public class EmiModel
    {
        public int Index { get; set; }
        public DateTime Date { get; set; }
        public string? Mode { get; set; }
        public decimal Amount { get; set; }
        public bool IsPaid { get; set; }
    }

    public class UserDetailResponse
    {
        public bool isSuccess { get; set; }
        public IosUserDetail data { get; set; }
    }

    public class IosUserDetail
    {
        public string customerId { get; set; }   // ← MUST BE FIRST OR ANYWHERE INSIDE

        public string loanAccountNumber { get; set; }
        public string name { get; set; }
        public string mobile { get; set; }
        public string alternateMobile { get; set; }
        public string serialNumber { get; set; }

        public bool isLock { get; set; }
        public bool isCameraLock { get; set; }
        public bool isRemoveApp { get; set; }
        public bool isRestrictions { get; set; }
        public bool isActivation { get; set; }
        public bool isSocialMediaLock { get; set; }
    }
     public class ShowLoanResponse
    {
        public bool isSuccess { get; set; }
        public List<ShowLoanData> data { get; set; }
        public string message{get; set;}
    } 
    public class ShowLoanData
    {
        public string id { get; set; }
        public string customerId { get; set; }
        public string productName { get; set; }
        public decimal productPrice { get; set; }
        public decimal processingFee { get; set; }
        public decimal downPayment { get; set; }
        public decimal loanAmount { get; set; }
        public int numberOfEmi { get; set; }
        public decimal actualEmi { get; set; }
        public DateTime firstEmiDate { get; set; }
        public bool isActive { get; set; }
        public decimal interest { get; set; }
    }
  private async Task CreateLoan()
{
    try
    {
        if (string.IsNullOrWhiteSpace(Session.DealerProfileId) ||
            string.IsNullOrWhiteSpace(userDetail?.customerId) ||
            string.IsNullOrWhiteSpace(productName) ||
            string.IsNullOrWhiteSpace(SerialNumber))
        {
            Console.WriteLine("Required fields missing");
            return;
        }

        var form = new MultipartFormDataContent();

        form.Add(new StringContent(Session.DealerProfileId), "DealerId");
        form.Add(new StringContent(userDetail.customerId), "CustomerId");
        form.Add(new StringContent(userDetail.name ?? ""), "CustomerName");

        form.Add(new StringContent(productName), "ProductName");
        form.Add(new StringContent(productPrice.ToString()), "ProductPrice");
        form.Add(new StringContent(processingFee.ToString()), "ProcessingFee");
        form.Add(new StringContent(downPayment.ToString()), "DownPayment");
        form.Add(new StringContent(loanAmount.ToString()), "LoanAmount");
        form.Add(new StringContent(numberOfEmi.ToString()), "NumberOfEmi");
        form.Add(new StringContent(actualEmi.ToString()), "ActualEmi");

        form.Add(new StringContent(firstEmiDate.ToString("yyyy-MM-ddTHH:mm:ss")), "FirstEmiDate");

        form.Add(new StringContent("0"), "Interest"); // REQUIRED
        form.Add(new StringContent(SerialNumber), "SerialNumber");

        Http.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", Session.Token);

        var response = await Http.PostAsync(
            "https://devmobileapi.plutosafe.in/api/IOSCustomerLoan/AddIOSCustomerLoan",
            form);

        var result = await response.Content.ReadAsStringAsync();
        Console.WriteLine(result);

        if (!response.IsSuccessStatusCode)
        {
            Console.WriteLine("API Failed");
            return;
        }

        var loanResponse = JsonSerializer.Deserialize<CreateLoanResponse>(
            result,
            new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

        if (loanResponse?.isSuccess == true)
        {
            Nav.NavigateTo("/submit-success");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine(ex.Message);
    }
}
    public class CreateLoanResponse
    {
        public bool isSuccess { get; set; }
        public CreateLoanData data { get; set; }
        public string message { get; set; }
    }

    public class CreateLoanData
    {
        public Loan loan { get; set; }
        public bool isActiveLoan { get; set; }
    }

    public class Loan
    {
        public string dealerId { get; set; }
        public string customerId { get; set; }
        public string productName { get; set; }
        public decimal productPrice { get; set; }
        public decimal processingFee { get; set; }
        public decimal downPayment { get; set; }
        public decimal loanAmount { get; set; }
        public int numberOfEmi { get; set; }
        public decimal actualEmi { get; set; }
        public DateTime firstEmiDate { get; set; }
        public decimal interest { get; set; }
        public string id { get; set; }
    }

    decimal TotalPaidAmount => 0; 
    decimal BalanceAmount => showLoanData?.loanAmount ?? 0;
    decimal EmiDueAmount => showLoanData?.actualEmi ?? 0;
    decimal PenaltyAmount => 0;
}
