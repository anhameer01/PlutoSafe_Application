@page "/my-profile"
@using System.Text.Json
@using System.Net.Http.Headers
@inject NavigationManager Nav
@inject HttpClient Http
@inject UserSession Session 

<div class="profile-page">

    <div class="profile-header">
        <span class="back" @onclick='() => Nav.NavigateTo("/dashboard")'>&larr;</span>
        <h3>My Profile</h3>
    </div>

    <div class="profile-card">

        <img src="images/avatar-girl.svg" class="profile-avatar" />
        <h4>@dealer?.dealerName</h4>
        <p class="mobile">+@dealer?.phone</p>

        <div class="profile-field">
            <label>Email</label>
            <div class="field-box">
                <img src="images/email.svg" />
                <span>@dealer?.email</span>
            </div>
        </div>

        <div class="profile-field">
            <label>Dealer Code</label>
            <div class="field-box">
                <img src="images/dealer.svg" />
                <span>@dealer?.dealerCode</span>
            </div>
        </div>

        <div class="profile-field">
            <label>Agency Name</label>
            <div class="field-box">
                <img src="images/address.svg" />
                <span>@dealer?.shopName</span>
            </div>
        </div>

        <div class="profile-field">
            <label>Address</label>
            <div class="field-box">
                <img src="images/address.svg" />
                <span>@dealer?.address</span>
            </div>
        </div>

        <div class="profile-field">
            <label>City</label>
            <div class="field-box">
                <img src="images/city.svg" />
                <span>@dealer?.city</span>
            </div>
        </div>

        <div class="profile-field">
            <label>State</label>
            <div class="field-box">
                <img src="images/state.svg" />
                <span>@dealer?.state</span>
            </div>
        </div>

        <div class="profile-field">
            <label>Pin Code</label>
            <div class="field-box">
                <img src="images/pincode.svg" />
                <span>@dealer?.pincode</span>
            </div>
        </div>

    </div>
</div>

@code {

    DealerProfile? dealer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDealer();
            StateHasChanged();
        }
    }

    async Task LoadDealer()
{
    try
    {
        var dealerId = Session.DealerProfileId;

        Http.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", Session.Token);

        var httpResponse = await Http.GetAsync(
            $"https://devmobileapi.plutosafe.in/api/DealerProfile/GetDealer/{dealerId}");

        Console.WriteLine("Status Code: " + httpResponse.StatusCode);

        var content = await httpResponse.Content.ReadAsStringAsync();
        Console.WriteLine("Raw Response: " + content);

        if (httpResponse.IsSuccessStatusCode)
        {
            var response = System.Text.Json.JsonSerializer.Deserialize<DealerResponse>(
                content,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (response != null && response.isSuccess)
                dealer = response.data;
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine("ERROR: " + ex.Message);
    }
}
    public class DealerResponse
    {
        public bool isSuccess { get; set; }
        public DealerProfile data { get; set; }
    }

    public class DealerProfile
{
    public string dealerName { get; set; }
    public string phone { get; set; }
    public string email { get; set; }
    public int dealerCode { get; set; }
    public string shopName { get; set; }
    public string address { get; set; }
    public string city { get; set; }
    public string state { get; set; }
    public string pincode { get; set; }
}
}