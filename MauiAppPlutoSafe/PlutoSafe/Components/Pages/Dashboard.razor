@* @page "/"  *@
@page "/dashboard"
@using System.Threading.Tasks
@inject NavigationManager Nav
@inject UserSession Session
@inject HttpClient Http

<link href="css/dashboard-main.css" rel="stylesheet" />

<div class="db-bg @(isIphone ? "iphone" : "android")">

    <!-- HEADER -->
    <div class="db-header">
        <div class="user-info">
            <p class="welcome">
                @(isIphone ? "Welcome To iPhone Dashboard" : "Welcome To Android Dashboard")
            </p>
            <h3>Pooja Puttichai</h3>
        </div>
        <button class="device-btn" @onclick="ToggleDevice">
            <img src="@DeviceImage" />
        </button>
    </div>

    <!-- SCROLLABLE CONTENT -->
    <div class="db-scroll">

        <!-- MAIN LOCK CARD -->
        <div class="lock-wrapper">
            <div class="lock-card">
                @if (!CurrentSlide.IsFullImage)
                {
                    <div class="lock-content">
                        <img src="@CurrentSlide.Image" class="main-icon slide" />
                        <p class="lock-text">All Your Loans, One Smart Locker</p>
                    </div>
                }
                else
                {
                    <img src="@CurrentSlide.Image" class="full-slide slide" />
                }
            </div>

            <div class="lock-dots">
                @for (int i = 0; i < Slides.Count; i++)
                {
                    <span class="dot @(activeIndex == i ? "active" : "")"></span>
                }
            </div>
        </div>

        @if (isIphone)
        {
            <div class="iphone-status-banner">
                <img src="images/apple.png" />
            </div>
        }

        <!-- STATUS LIST -->
        <div class="status-list">
            <div class="status-blue" @onclick='() => Nav.NavigateTo("/today-activation")'>
                <img src="images/icon-activation.svg" />
                <span>Today's Activation</span><b>@Session.TodayActivationCount</b>
            </div>
            <div class="status-purple" @onclick='() => Nav.NavigateTo("/pending-phone")'>
                <img src="images/icon-pending-phone.svg" />
                <span>Pending Phone</span><b>@Session.PendingCount</b>
            </div>
            <div class="status-green" @onclick='() => Nav.NavigateTo("/active-phone")'>
                <img src="images/icon-active-phone.svg" />
                <span>Active Phone</span><b>@Session.ActiveCount</b>
            </div>
            <div class="status-cyan" @onclick='() => Nav.NavigateTo("/lock-phone")'>
                <img src="images/icon-lock-phone.svg" />
                <span>Lock Phone</span><b>@Session.LockedCount</b>
            </div>
            <div class="status-yellow" @onclick='() => Nav.NavigateTo("/removed-phone")'>
                <img src="images/icon-removed-phone.svg" />
                <span>Removed Phone</span><b>@Session.RemovedCount</b>
            </div>
            <div class="status-lime" @onclick='() => Nav.NavigateTo("/unlock-phone")'>
                <img src="images/icon-unlock-phone.svg" />
                <span>Unlock Phone</span><b>@Session.UnlockedCount</b>
            </div>
            <div class="status-orange" @onclick='() => Nav.NavigateTo("/remaining-key")'>
                <img src="images/icon-remaining-phone.svg" />
                <span>Remaining Key</span><b>@Session.RemainingKeyCount</b>
            </div>
            <div class="status-pink">
                <img src="images/icon-unassigned-phone.svg" />
                <span>Unassigned Phone</span><b>@Session.UnassignedCount</b>
            </div>
        </div>

        <h4 class="section">Quick Action</h4>

        <div class="quick-actions-new">
            @if (isIphone)
            {
                <button class="qa-item" @onclick='() => Nav.NavigateTo("/add-user?device=iphone")'>
                    <img src="images/icon-add-user-iphone.svg" /><p>Add Customers</p>
                </button>
                <button class="qa-item" @onclick='() => Nav.NavigateTo("/qr-code")'>
                    <img src="images/icon-qr-code-iphone.svg" /><p>QR Code</p>
                </button>
                <button class="qa-item" @onclick='() => Nav.NavigateTo("/qr-code")'>
                    <img src="images/icon-qr-code-iphone.svg" /><p>Running QR</p>
                </button>
            }

            <button class="qa-item" @onclick='() => Nav.NavigateTo("/license-history")'>
                <img src="images/licenseshistory.svg" /><p>License History</p>
            </button>
            <button class="qa-item" @onclick='() => Nav.NavigateTo("/video-training")'>
                <img src="images/videotraining.svg" /><p>Video Training</p>
            </button>
            <button class="qa-item" @onclick='() => Nav.NavigateTo("/user-list")'>
                <img src="images/userlist.svg" /><p>User List</p>
            </button>
            <button class="qa-item" @onclick='() => Nav.NavigateTo("/my-profile")'>
                <img src="images/userprofile.svg" /><p>User Profile</p>
            </button>
            <button class="qa-item" @onclick='() => Nav.NavigateTo("/remaining-devices")'>
                <img src="images/remainingdevice.svg" /><p>Remaining Devices</p>
            </button>
        </div>
    </div>

    <div class="db-footer">
        @if (!isIphone)
        {
            <button class="footer-btn" @onclick='() => Nav.NavigateTo("/add-user?device=isIphone")'>
                <img src="images/icon-add-user.svg" />
            </button>
            <button class="footer-btn" @onclick='() => Nav.NavigateTo("/qr-code")'>
                <img src="images/icon-qr-code.svg" />
            </button>
            <button class="footer-btn" @onclick='() => Nav.NavigateTo("/qr-code")'>
                <img src="images/icon-running-qr.svg" />
            </button>
            <button class="footer-btn" @onclick="Logout">
                <img src="images/icon-logout.svg" />
            </button>
        }
    </div>

    @if (isIphone)
    {
        <div class="iphone-logout-wrapper">
            <button class="iphone-logout-btn" @onclick="Logout">LogOut</button>
        </div>
    }
</div>

@code {
    bool isIphone = false; // Android default
    int activeIndex = 0;
    CancellationTokenSource sliderCts;

    string DeviceImage => isIphone
        ? "images/iphone.svg"
        : "images/android.svg";

    protected override async Task OnInitializedAsync()
    {
        StartSlider();          // keep slider working
        await LoadDashboardCounts();  // load API counts
    }
    async Task LoadDashboardCounts()
    {
        var dealerId = Session.DealerProfileId;

        if (string.IsNullOrEmpty(dealerId))
            return;

        Http.DefaultRequestHeaders.Authorization =
            new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Session.Token);

        try
        {
            var pending = await Http.GetFromJsonAsync<CountResponse>(
                $"api/IOSDashboardDevicesList/GetPendingIOSDeviceCount/{dealerId}");

            var locked = await Http.GetFromJsonAsync<CountResponse>(
                $"api/IOSDashboardDevicesList/GetLockedIOSDeviceCount/{dealerId}");

            var removed = await Http.GetFromJsonAsync<CountResponse>(
                $"api/IOSDashboardDevicesList/GetRemovedIOSDeviceCount/{dealerId}");

            var unlocked = await Http.GetFromJsonAsync<CountResponse>(
                $"api/IOSDashboardDevicesList/GetUnlockedIOSDeviceCount/{dealerId}");

            var remaining = await Http.GetFromJsonAsync<CountResponse>(
                $"api/IOSDashboardDevicesList/GetRemainingIOSKeys/{dealerId}");

            if (pending != null) Session.PendingCount = pending.data;
            if (locked != null) Session.LockedCount = locked.data;
            if (removed != null) Session.RemovedCount = removed.data;
            if (unlocked != null) Session.UnlockedCount = unlocked.data;
            if (remaining != null) Session.RemainingKeyCount = remaining.data;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    public class CountResponse
    {
        public bool isSuccess { get; set; }
        public int data { get; set; }
        public string message { get; set; }
    }

    void ToggleDevice()
    {
        isIphone = !isIphone;
        activeIndex = 0;
    }

    async void StartSlider()
    {
        sliderCts = new CancellationTokenSource();
        //to gain control over system cancellation process
        try
        {
            while (!sliderCts.Token.IsCancellationRequested)
            {
                await Task.Delay(2300);
                activeIndex = (activeIndex + 1) % Slides.Count;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch { }
    }

    public void Dispose() => sliderCts?.Cancel();

    void Logout() => Nav.NavigateTo("/login");

    class Slide
    {
        public string Image { get; set; }
        public bool IsFullImage { get; set; }
    }

    List<Slide> Slides => isIphone
        ? new()
        {
            new(){Image="images/welcome-iphone.svg",IsFullImage=true},
            new(){Image="images/iphone-slide1.svg",IsFullImage=true},
            new(){Image="images/iphone-slide2.svg",IsFullImage=true},
            new(){Image="images/iphone-slide.png",IsFullImage=true}
        }
        : new()
        {
            new(){Image="images/welcome-android.svg",IsFullImage=true},
            new(){Image="images/android-slide1.svg",IsFullImage=true},
            new(){Image="images/android-slide2.svg",IsFullImage=true},
            new(){Image="images/icon-all-loans.png",IsFullImage=false},
            new(){Image="images/image2.svg",IsFullImage=true}
        };

    Slide CurrentSlide => Slides[activeIndex];
}